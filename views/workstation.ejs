<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= platform.charAt(0).toUpperCase() + platform.slice(1) %> Workstation</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/onboarding.css">
    <link rel="stylesheet" href="/css/components/platform-profile.css">
</head>
<body data-soc-id="<%= socId %>" data-case-id="<%= caseId %>">
    <%- include('partials/navigation', { activePage: 'workstation' }) %>
    
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="sst-logo">SST</div>
            <h1 class="platform-title"><%= platform.charAt(0).toUpperCase() + platform.slice(1) %> Workstation</h1>
            <div class="progress-indicator" id="progressIndicator">
                <% if (platformData.photos.length > 0) { %>
                    Photo 1 of <%= platformData.photos.length %>
                <% } else { %>
                    No photos
                <% } %>
            </div>
        </div>
        <div class="header-actions">
            <button id="caseContextToggleBtn" class="btn btn-info">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                </svg>
                Case Info
            </button>
            <button id="clearSessionBtn" class="btn btn-danger">Clear Session</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Platform Sidebar - Only shows platforms that have been set up -->
        <div class="sidebar">
            <% allPlatforms.forEach(function(p) { %>
                <a href="/soc/<%= socId %>/platform/<%= p %>?caseId=<%= caseId %>" class="platform-icon <%= p === platform ? 'active' : '' %>">
                    <span><%= p.substring(0, 2).toUpperCase() %></span>
                    <% if (p === platform && platformData.photos.length > 0) { %>
                        <span class="platform-progress"><%= platformData.photos.filter(photo => Object.keys(photo.analysisTags).length > 0).length %>/<%= platformData.photos.length %></span>
                    <% } %>
                </a>
            <% }); %>
            
            <!-- Add Platform Button -->
            <a href="/workstation?caseId=<%= caseId %>" class="add-platform-btn" title="Add Platform">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </a>
        </div>

        <%- include('partials/photo-grid') %>

        <!-- Main Workspace -->
        <div class="workspace">
            <div class="workspace-content">
                <% if (platformData.photos.length > 0) { %>
                    <!-- Image Viewer -->
                    <div class="image-viewer">
                        <img src="<%= platformData.photos[0].file_path %>" alt="Current photo" class="current-image" id="currentImage">
                        
                        <div class="image-tools">
                            <button class="tool-btn" id="zoomBtn">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                                Zoom
                            </button>
                            <button class="tool-btn" id="annotateBtn">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                                Annotate
                            </button>
                            <button class="tool-btn" id="analyticsBtn">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                Analytics
                            </button>
                        </div>
                    </div>

                    <!-- Analysis Panel -->
                    <div class="analysis-panel">
                        <!-- Platform Info Toggle Button -->
                        <button class="platform-info-toggle" id="platformInfoToggleBtn" title="Show Platform Profile">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                            </svg>
                        </button>

                        <!-- Analyze Button -->
                        <button class="analyze-btn" id="analyzeBtn">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                            </svg>
                            Analyze Photo
                        </button>

                        <div class="panel-section">
                            <h3 class="section-title">Tags</h3>
                            <div class="tags-container" id="tagsContainer">
                                <% if (platformData.photos.length > 0 && platformData.photos[0].tags.length > 0) { %>
                                    <% platformData.photos[0].tags.forEach(function(tag) { %>
                                        <span class="tag">
                                            <%= tag %>
                                            <span class="tag-remove" data-tag="<%= tag %>">Ã—</span>
                                        </span>
                                    <% }); %>
                                <% } %>
                            </div>
                            <input type="text" class="add-tag-input" id="addTagInput" placeholder="Add a tag...">
                        </div>

                        <div class="panel-section">
                            <h3 class="section-title">Notes</h3>
                            <textarea class="notes-textarea" id="notesTextarea" placeholder="Add your notes about this photo..."><%= platformData.photos.length > 0 ? platformData.photos[0].notes : '' %></textarea>
                        </div>

                        <div class="panel-section">
                            <h3 class="section-title">Image Details</h3>
                            <div class="image-details">
                                <% if (platformData.photos.length > 0) { %>
                                    <div class="detail-row">
                                        <span class="detail-label">Posted:</span>
                                        <span class="detail-value"><%= platformData.photos[0].metadata.posted %></span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Likes:</span>
                                        <span class="detail-value"><%= platformData.photos[0].metadata.likes %></span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Comments:</span>
                                        <span class="detail-value"><%= platformData.photos[0].metadata.comments %></span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Engagement Rate:</span>
                                        <span class="detail-value"><%= platformData.photos[0].metadata.engagementRate %></span>
                                    </div>
                                <% } else { %>
                                    <div class="detail-row">
                                        <span class="detail-label">No photo selected</span>
                                        <span class="detail-value"></span>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <!-- Empty State -->
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“·</div>
                        <div class="empty-state-message">No photos yet. Click "Add" to upload photos.</div>
                        <button class="btn btn-primary" id="emptyStateAddBtn">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                            </svg>
                            Add Photos
                        </button>
                    </div>
                <% } %>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="save-indicator" id="saveIndicator">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                    </svg>
                    All changes saved
                </div>
                <div class="action-group">
                    <button class="btn btn-secondary" id="previewReportBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Preview Report
                    </button>
                    <button class="btn btn-secondary" id="saveProgressBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        Save Progress
                    </button>
                    <button class="btn btn-primary" id="generateReportBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/upload-modal') %>
    <%- include('partials/analysis-modal') %>
    <%- include('partials/case-context-bar') %>
    <%- include('partials/platform-profile-bar') %>

    <!-- Add SOC Modal -->
    <div class="modal" id="addSocModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New SOC</h2>
                <button class="close-btn" id="closeAddSocBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addSocForm">
                    <div class="form-group">
                        <label for="socName">Name</label>
                        <input type="text" id="socName" class="form-input" placeholder="Enter SOC name" required>
                    </div>
                    <div class="form-group">
                        <label for="socStudentId">Student ID</label>
                        <input type="text" id="socStudentId" class="form-input" placeholder="Enter student ID">
                    </div>
                    <div class="form-group">
                        <label for="socGrade">Grade</label>
                        <input type="text" id="socGrade" class="form-input" placeholder="Enter grade">
                    </div>
                    <div class="form-group">
                        <label for="socSchool">School</label>
                        <input type="text" id="socSchool" class="form-input" placeholder="Enter school">
                    </div>
                    <div class="form-group">
                        <label for="socDob">Date of Birth</label>
                        <input type="date" id="socDob" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="socStatus" value="known" checked>
                                Known
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="socStatus" value="potential">
                                Potential
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitAddSocBtn">Add SOC</button>
                </form>
            </div>
        </div>
    </div>

<script src="/js/navigation.js"></script>
<script src="/js/platform-profile.js"></script>
<script src="/js/workstation.js?v=<%= new Date().getTime() %>" type="module"></script>
</body>
</html>
