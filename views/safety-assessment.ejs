<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Assessment - Digital Threat Assessment Management</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/onboarding.css">
    <script src="/js/onboarding.js"></script>
</head>
<body class="onboarding-body">
    <div class="onboarding-container">
        <div class="onboarding-card">
            <div class="onboarding-header">
                <h1>Digital Threat Assessment Management</h1>
            </div>
            <div class="onboarding-content">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-step completed">1</div>
                        <div class="progress-step completed">2</div>
                        <div class="progress-step completed">3</div>
                        <div class="progress-step active">4</div>
                    </div>
                    <div class="progress-labels">
                        <div class="progress-label completed">Terms</div>
                        <div class="progress-label completed">SOC</div>
                        <div class="progress-label completed">Case</div>
                        <div class="progress-label active">Summary</div>
                    </div>
                </div>
                
                <h2>Threat Assessment Protocol</h2>
                <p>Before proceeding, please answer the following threat assessment questions. These questions are designed to help you determine the immediate risk level posed by the Subject of Concern (SOC).</p>
                
                <form action="/summary" method="POST" class="onboarding-form" id="safetyAssessmentForm">
                    <input type="hidden" name="safetyAssessment" id="safetyAssessmentInput" value="{}">
                    
                    <div class="safety-question">
                        <div class="safety-question-title">
                            1. Does this situation require immediate law enforcement response?
                            <span class="info-icon" onclick="toggleHelp('enforcement-help')">?</span>
                        </div>
                        <div class="safety-options">
                            <div class="safety-option" data-question="enforcement" data-value="yes" onclick="selectSafetyOption(this)">Yes</div>
                            <div class="safety-option" data-question="enforcement" data-value="no" onclick="selectSafetyOption(this)">No</div>
                            <div class="safety-option" data-question="enforcement" data-value="unknown" onclick="selectSafetyOption(this)">Unknown</div>
                        </div>
                        <div class="safety-help-content" id="enforcement-help">
                            This helps determine if immediate emergency protocols need to be activated before proceeding with the threat assessment process.
                        </div>
                    </div>
                    
                    <div class="safety-question">
                        <div class="safety-question-title">
                            2. Does the subject of concern have immediate access to the means to carry out a threat?
                            <span class="info-icon" onclick="toggleHelp('means-help')">?</span>
                        </div>
                        <div class="safety-options">
                            <div class="safety-option" data-question="means" data-value="yes" onclick="selectSafetyOption(this)">Yes</div>
                            <div class="safety-option" data-question="means" data-value="no" onclick="selectSafetyOption(this)">No</div>
                            <div class="safety-option" data-question="means" data-value="unknown" onclick="selectSafetyOption(this)">Unknown</div>
                        </div>
                        <div class="safety-help-content" id="means-help">
                            This ensures that proper searches have been conducted (locker, backpack, person) and that any weapons or materials that could be used to carry out the threat have been secured or removed.
                        </div>
                    </div>
                    
                    <div id="enforcementWarningBox" class="warning-box" style="display: none;">
                        <div class="warning-title">
                            <svg class="warning-icon" viewBox="0 0 24 24">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                            </svg>
                            IMMINENT RISK
                        </div>
                        <div class="warning-content">
                            Call your local law enforcement agency and follow your emergency response protocols. Continue with a threat assessment process when safe to do so.
                        </div>
                    </div>
                    
                    <div id="meansWarningBox" class="warning-box" style="display: none;">
                        <div class="warning-title">
                            <svg class="warning-icon" viewBox="0 0 24 24">
                                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                            </svg>
                            IMMINENT RISK
                        </div>
                        <div class="warning-content">
                            Immediate risk reducing intervention is to remove access to the means (e.g. firearm, Molotov cocktail, knife or other related weapons).
                        </div>
                    </div>
                    
                    <div id="proceedBox" class="proceed-box" style="display: none;">
                        <div class="proceed-title">
                            <svg class="proceed-icon" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            PROCEED
                        </div>
                        <div class="proceed-content">
                            You may proceed with the Digital Threat Assessment process.
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <a href="/case-info" class="btn btn-secondary btn-back">Back</a>
                        <button type="submit" class="btn btn-primary" id="continueBtn" disabled>Continue</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize assessment object
        let safetyAssessment = {
            enforcement: null,
            means: null
        };
        
        function selectSafetyOption(element) {
            // Get question and value
            const question = element.dataset.question;
            const value = element.dataset.value;
            
            // Remove selected class from all options in this question
            document.querySelectorAll(`.safety-option[data-question="${question}"]`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update assessment object
            safetyAssessment[question] = value;
            
            // Update hidden input
            document.getElementById('safetyAssessmentInput').value = JSON.stringify(safetyAssessment);
            
            // Check if all questions are answered
            const allAnswered = Object.values(safetyAssessment).every(value => value !== null);
            
            // Enable continue button if all questions are answered
            document.getElementById('continueBtn').disabled = !allAnswered;
            
            // Check for high risk conditions
            checkForHighRisk();
        }
        
        function toggleHelp(id) {
            const helpContent = document.getElementById(id);
            helpContent.classList.toggle('active');
        }
        
        function checkForHighRisk() {
            // Show warning based on responses
            const enforcementRisk = safetyAssessment.enforcement === 'yes';
            const meansRisk = safetyAssessment.means === 'yes';
            
            // Show appropriate warning boxes
            document.getElementById('enforcementWarningBox').style.display = enforcementRisk ? 'block' : 'none';
            document.getElementById('meansWarningBox').style.display = meansRisk ? 'block' : 'none';
            
            // Show proceed box if all answers are No or Unknown
            const canProceed = safetyAssessment.enforcement !== 'yes' && 
                              safetyAssessment.means !== 'yes' &&
                              safetyAssessment.enforcement !== null &&
                              safetyAssessment.means !== null;
            
            document.getElementById('proceedBox').style.display = canProceed ? 'block' : 'none';
        }
    </script>
</body>
</html>
